return(df_plot)
}
################only test the parameter a2#############
p_tmin_a2<-plot_para_each(plot_data,"tmin","a2",TRUE)
p_tmin_a2
p_tmin_b_GP_a2<-plot_para_each(plot_data,"tmin_b_GP","a2",TRUE)
p_tmin_b_GP_a2
p_tmin_a2
p_tmin_GP_a2<-plot_para_each(plot_data,"tmin_GP","a2",TRUE)
p_tmin_ES_a2<-plot_para_each(plot_data,"tmin_ES","a2",TRUE)
#merge the plots:
paras_general_range<-cowplot::plot_grid(p_tmin_a2,p_tmin_b_GP_a2,
p_tmin_GP_a2,p_tmin_ES_a2,
nrow=2, ncol = 2,labels = "auto",label_size = 20,align = "hv")
paras_general_range
#2)for sites and groups(PFT):
library(ggforce)
library(ggrepel)
plot_paras<-function(df,Env_var,para,do_legend){
# df<-plot_data
# Env_var<-"tmin_b_GP"
# para<-"a2"
# do_legend=FALSE
# for example: tmin_b_GP vs a2
#I.site-level
df_site_level<-df %>%
dplyr::select(sitename,PFT,koeppen_code,Clim.PFTs,para,Env_var,temp)
names(df_site_level)<-c("sitename","PFT","Clim.","Clim.PFTs","para","Env_var","tmean")
#
t_pos<-match(Env_var,names(df_site_level))
df_site_level_new<-df_site_level
names(df_site_level_new)[t_pos]<-"Env_var"
#III.PFT level---
df_PFT_level<-df_site_level%>%
mutate(PFT=factor(PFT,levels = c("DBF","MF","ENF")))%>%
group_by(PFT)%>%
dplyr::summarise(Env_var=mean(Env_var,na.rm=T),
tmean=mean(tmean,na.rm=T),
para=mean(para,na.rm = T))
##----plotting----##
library(ggpmisc)
# library(ggpubr)
#linear regression:
#----DBF------
lm_DBF<-lm(data=df_site_level_new[df_site_level_new$PFT=='DBF',],
para~Env_var)
stat_lm_DBF<-summary(lm_DBF)
stat_DBF_label<-data.frame(r.squared=round(stat_lm_DBF$r.squared,2),
p.value=round(coef(stat_lm_DBF)[2,4],4))
#----Dfc-ENF-----
lm_Dfc_ENF<-lm(data=df_site_level_new[df_site_level_new$Clim.PFTs=='Dfc-ENF',],
para~Env_var)
stat_lm_Dfc_ENF<-summary(lm_Dfc_ENF)
stat_Dfc_ENF_label<-data.frame(r.squared=round(stat_lm_Dfc_ENF$r.squared,2),
p.value=round(coef(stat_lm_Dfc_ENF)[2,4],4))
pars_final<-ggplot()+
geom_point(data=df_site_level_new,aes(x=Env_var,y=para,col=PFT),size=3)+
# scale_color_discrete_sequential(palette = "Viridis")+
geom_text_repel(data=df_site_level_new,aes(x=Env_var,y=para,label=sitename),size=5)+
stat_poly_line(data=df_site_level_new[df_site_level_new$PFT=='DBF',],
aes(x=Env_var,y=para,col=PFT),
fill=adjustcolor("goldenrod1"),method = "lm",formula = y ~ x,lty=2)+
# stat_poly_eq(data=df_site_level_new[df_site_level_new$PFT=='DBF',],
#                aes(x=Env_var,y=para,col=PFT,
#                    label = paste(
#                                  # after_stat(grp.label), "*\"：\"*",
#                                  # after_stat(eq.label), "*\", \"*",
#                                  after_stat(rr.label),
#                                  after_stat(p.value.label),
#                                  sep = "*\", \"*"),
#                    label.x=0.5,label.y="bottom"))+
# ggforce::geom_mark_ellipse(data=df_site_level_new[df_site_level_new$PFT=='DBF',],
#                            aes(x=Env_var,y=para,label=PFT,group=PFT,col=PFT),label.fill = "goldenrod1",
#                            con.border = "one",con.cap = 0,con.size = 1.1,con.colour = "goldenrod1",
#                            con.arrow = grid::arrow(angle=30,ends = "last",length = unit(0.1,"inches")))+  ##DBF
stat_poly_line(data=df_site_level_new[df_site_level_new$Clim.PFTs=='Dfc-ENF',],
aes(x=Env_var,y=para,col=PFT),fill=adjustcolor("magenta1"),
method = "lm",formula = y ~ x,lty=2)+
# stat_poly_eq(data=df_site_level_new[df_site_level_new$Clim.PFTs=='Dfc-ENF',],
#                  aes(x=Env_var,y=para,col=PFT,
#                     label = paste(
#                       after_stat(rr.label),
#                       after_stat(p.value.label),
#                       sep = "*\", \"*"),
#                 label.x=0.5,label.y="bottom"))+
# ggforce::geom_mark_ellipse(data=df_site_level_new[df_site_level_new$Clim.PFTs=="Dfc-ENF",],
#                            aes(x=Env_var,y=para,label=Clim.PFTs,group=Clim.PFTs,col=PFT),label.fill = "magenta1",
#                            con.border = "one",con.cap = 0,con.size = 1.1,con.colour = "magenta1",
#                            con.arrow = grid::arrow(angle=30,ends = "last",length = unit(0.1,"inches")))+  ##Dfc-ENF
scale_color_manual(values = c("DBF"="orange","MF"="cyan","ENF"="magenta"))+
xlab(paste0(Env_var," (°C)"))+
ylab(paste0(para," (°C)"))+
theme(
legend.text = element_text(size=22),
legend.position = c(0.15,0.8),
legend.key.size = unit(2, 'lines'),
axis.title = element_text(size=26),
axis.text = element_text(size = 22),
text = element_text(size=24),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.background = element_rect(colour ="grey",fill="white")
)
if(para=="a1"){
pars_final<-pars_final+
annotate(geom = "text",x=-4.1,y=33,label = paste0("italic(R) ^ 2 == ",
stat_DBF_label$r.squared),parse=TRUE,col="orange",size=5)+
annotate(geom = "text",x=1,y=33,label = paste0("italic(p) ==",
round(stat_DBF_label$p.value,2)),parse=TRUE,col="orange",size=5)+
annotate(geom = "text",x=-4.1,y=29,label = paste0("italic(R) ^ 2 == ",
stat_Dfc_ENF_label$r.squared),parse=TRUE,col="magenta",size=5)+
annotate(geom = "text",x=1,y=29,label = paste0("italic(p) == ",
round(stat_Dfc_ENF_label$p.value,2)),parse=TRUE,col="magenta",size=5)
}
##tmin vs a2
if(para=="a2" & Env_var=="tmin"){
pars_final<-pars_final+
annotate(geom = "text",x=-4.1,y=210,label = paste0("italic(R) ^ 2 == ",
stat_DBF_label$r.squared),parse=TRUE,col="orange",size=5)+
annotate(geom = "text",x=1,y=210,label = paste0("italic(p) ==",
round(stat_DBF_label$p.value,2)),parse=TRUE,col="orange",size=5)+
annotate(geom = "text",x=-4.1,y=192,label = paste0("italic(R) ^ 2 == ",
stat_Dfc_ENF_label$r.squared),parse=TRUE,col="magenta",size=5)+
annotate(geom = "text",x=1,y=192,label = paste0("italic(p) == ",
round(stat_Dfc_ENF_label$p.value,2)),parse=TRUE,col="magenta",size=5)
}
if(para=="a2" & Env_var=="tmin_b_GP"){
pars_final<-pars_final+
annotate(geom = "text",x=-25.1,y=210,label = paste0("italic(R) ^ 2 == ",
stat_DBF_label$r.squared),parse=TRUE,col="orange",size=5)+
annotate(geom = "text",x=-20,y=210,label = paste0("italic(p) ==",
round(stat_DBF_label$p.value,2)),parse=TRUE,col="orange",size=5)+
annotate(geom = "text",x=-25.1,y=192,label = paste0("italic(R) ^ 2 == ",
stat_Dfc_ENF_label$r.squared),parse=TRUE,col="magenta",size=5)+
annotate(geom = "text",x=-20,y=192,label = paste0("italic(p) == ",
round(stat_Dfc_ENF_label$p.value,2)),parse=TRUE,col="magenta",size=5)
}
if(para=="a2" & Env_var=="tmin_GP"){
pars_final<-pars_final+
annotate(geom = "text",x=-4.1,y=210,label = paste0("italic(R) ^ 2 == ",
stat_DBF_label$r.squared),parse=TRUE,col="orange",size=5)+
annotate(geom = "text",x=1,y=210,label = paste0("italic(p) ==",
round(stat_DBF_label$p.value,2)),parse=TRUE,col="orange",size=5)+
annotate(geom = "text",x=-4.1,y=192,label = paste0("italic(R) ^ 2 == ",
stat_Dfc_ENF_label$r.squared),parse=TRUE,col="magenta",size=5)+
annotate(geom = "text",x=1,y=192,label = paste0("italic(p) == ",
round(stat_Dfc_ENF_label$p.value,2)),parse=TRUE,col="magenta",size=5)
}
if(para=="a2" & Env_var=="tmin_ES"){
pars_final<-pars_final+
annotate(geom = "text",x=-15.1,y=210,label = paste0("italic(R) ^ 2 == ",
stat_DBF_label$r.squared),parse=TRUE,col="orange",size=5)+
annotate(geom = "text",x=-10,y=210,label = paste0("italic(p) ==",
round(stat_DBF_label$p.value,2)),parse=TRUE,col="orange",size=5)+
annotate(geom = "text",x=-15.1,y=192,label = paste0("italic(R) ^ 2 == ",
stat_Dfc_ENF_label$r.squared),parse=TRUE,col="magenta",size=5)+
annotate(geom = "text",x=-10,y=192,label = paste0("italic(p) == ",
round(stat_Dfc_ENF_label$p.value,2)),parse=TRUE,col="magenta",size=5)
}
################
if(para=="b1"){
pars_final<-pars_final+
annotate(geom = "text",x=-4.1,y=22,label = paste0("italic(R) ^ 2 == ",
stat_DBF_label$r.squared),parse=TRUE,col="orange",size=5)+
annotate(geom = "text",x=1,y=22,label = paste0("italic(p) ==",
round(stat_DBF_label$p.value,2)),parse=TRUE,col="orange",size=5)+
annotate(geom = "text",x=-4.1,y=20,label = paste0("italic(R) ^ 2 == ",
stat_Dfc_ENF_label$r.squared),parse=TRUE,col="magenta1",size=5)+
annotate(geom = "text",x=1,y=20,label = paste0("italic(p) == ",
round(stat_Dfc_ENF_label$p.value,2)),parse=TRUE,col="magenta1",size=5)
}
if(para=="b2"){
pars_final<-pars_final+
annotate(geom = "text",x=-4.1,y=20,label = paste0("italic(R) ^ 2 == ",
stat_DBF_label$r.squared),parse=TRUE,col="orange",size=5)+
annotate(geom = "text",x=1,y=20,label = paste0("italic(p) ==",
round(stat_DBF_label$p.value,2)),parse=TRUE,col="orange",size=5)+
annotate(geom = "text",x=-4.1,y=18,label = paste0("italic(R) ^ 2 == ",
stat_Dfc_ENF_label$r.squared),parse=TRUE,col="magenta1",size=5)+
annotate(geom = "text",x=1,y=18,label = paste0("italic(p) == ",
round(stat_Dfc_ENF_label$p.value,2)),parse=TRUE,col="magenta1",size=5)
}
if(para=="k"){
pars_final<-pars_final+
annotate(geom = "text",x=-10.1,y=15,label = paste0("italic(R) ^ 2 == ",
stat_DBF_label$r.squared),parse=TRUE,col="orange",size=5)+
annotate(geom = "text",x=-5,y=15,label = paste0("italic(p) ==",
round(stat_DBF_label$p.value,2)),parse=TRUE,col="orange",size=5)+
annotate(geom = "text",x=-10.1,y=13,label = paste0("italic(R) ^ 2 == ",
stat_Dfc_ENF_label$r.squared),parse=TRUE,col="magenta1",size=5)+
annotate(geom = "text",x=-5,y=13,label = paste0("italic(p) == ",
round(stat_Dfc_ENF_label$p.value,2)),parse=TRUE,col="magenta1",size=5)
}
if(do_legend==FALSE){
pars_final<-pars_final+
theme(legend.position = "none")
}
#
return(pars_final)
}
p_tmin_a2<-plot_paras(df = plot_data,Env_var = "tmin",
para = "a2",FALSE)
p_tmin_b_GP_a2<-plot_paras(df = plot_data,Env_var = "tmin_b_GP",
para = "a2",FALSE)
p_tmin_GP_a2<-plot_paras(df = plot_data,Env_var = "tmin_GP",
para = "a2",FALSE)
p_tmin_ES_a2<-plot_paras(df = plot_data,Env_var = "tmin_ES",
para = "a2",FALSE)
#merge the plots:
paras_range<-cowplot::plot_grid(p_tmin_a2,p_tmin_b_GP_a2,
p_tmin_GP_a2,p_tmin_ES_a2,
nrow=2, ncol = 2,labels = "auto",label_size = 20,align = "hv")
paras_range
################only test the parameter a2#############
p_tmin_a2<-plot_para_each(plot_data,"tmin","a2",TRUE)
p_tmin_b_GP_a2<-plot_para_each(plot_data,"tmin_b_GP","a2",TRUE)
p_tmin_GP_a2<-plot_para_each(plot_data,"tmin_GP","a2",TRUE)
p_tmin_ES_a2<-plot_para_each(plot_data,"tmin_ES","a2",TRUE)
#merge the plots:
paras_general_range<-cowplot::plot_grid(p_tmin_a2,p_tmin_b_GP_a2,
p_tmin_GP_a2,p_tmin_ES_a2,
nrow=2, ncol = 2,labels = "auto",label_size = 20,align = "hv")
#save the plot
save.path<-"./manuscript/test_files/check_paras_in_Beni_method/"
ggsave(paste0(save.path,"Check_paras_general_beni_method_min_Tmin_vs_a2.png"),
paras_general_range,width = 18,height = 15)
plot_paras<-function(df,Env_var,para,do_legend){
# df<-plot_data
# Env_var<-"tmin_b_GP"
# para<-"a2"
# do_legend=FALSE
# for example: tmin_b_GP vs a2
#I.site-level
df_site_level<-df %>%
dplyr::select(sitename,PFT,koeppen_code,Clim.PFTs,para,Env_var,temp)
names(df_site_level)<-c("sitename","PFT","Clim.","Clim.PFTs","para","Env_var","tmean")
#
t_pos<-match(Env_var,names(df_site_level))
df_site_level_new<-df_site_level
names(df_site_level_new)[t_pos]<-"Env_var"
#III.PFT level---
df_PFT_level<-df_site_level%>%
mutate(PFT=factor(PFT,levels = c("DBF","MF","ENF")))%>%
group_by(PFT)%>%
dplyr::summarise(Env_var=mean(Env_var,na.rm=T),
tmean=mean(tmean,na.rm=T),
para=mean(para,na.rm = T))
##----plotting----##
library(ggpmisc)
# library(ggpubr)
#linear regression:
#----DBF------
lm_DBF<-lm(data=df_site_level_new[df_site_level_new$PFT=='DBF',],
para~Env_var)
stat_lm_DBF<-summary(lm_DBF)
stat_DBF_label<-data.frame(r.squared=round(stat_lm_DBF$r.squared,2),
p.value=round(coef(stat_lm_DBF)[2,4],4))
#----Dfc-ENF-----
lm_Dfc_ENF<-lm(data=df_site_level_new[df_site_level_new$Clim.PFTs=='Dfc-ENF',],
para~Env_var)
stat_lm_Dfc_ENF<-summary(lm_Dfc_ENF)
stat_Dfc_ENF_label<-data.frame(r.squared=round(stat_lm_Dfc_ENF$r.squared,2),
p.value=round(coef(stat_lm_Dfc_ENF)[2,4],4))
pars_final<-ggplot()+
geom_point(data=df_site_level_new,aes(x=Env_var,y=para,col=PFT),size=3)+
# scale_color_discrete_sequential(palette = "Viridis")+
geom_text_repel(data=df_site_level_new,aes(x=Env_var,y=para,label=sitename),size=5)+
stat_poly_line(data=df_site_level_new[df_site_level_new$PFT=='DBF',],
aes(x=Env_var,y=para,col=PFT),
fill=adjustcolor("goldenrod1"),method = "lm",formula = y ~ x,lty=2)+
# stat_poly_eq(data=df_site_level_new[df_site_level_new$PFT=='DBF',],
#                aes(x=Env_var,y=para,col=PFT,
#                    label = paste(
#                                  # after_stat(grp.label), "*\"：\"*",
#                                  # after_stat(eq.label), "*\", \"*",
#                                  after_stat(rr.label),
#                                  after_stat(p.value.label),
#                                  sep = "*\", \"*"),
#                    label.x=0.5,label.y="bottom"))+
# ggforce::geom_mark_ellipse(data=df_site_level_new[df_site_level_new$PFT=='DBF',],
#                            aes(x=Env_var,y=para,label=PFT,group=PFT,col=PFT),label.fill = "goldenrod1",
#                            con.border = "one",con.cap = 0,con.size = 1.1,con.colour = "goldenrod1",
#                            con.arrow = grid::arrow(angle=30,ends = "last",length = unit(0.1,"inches")))+  ##DBF
stat_poly_line(data=df_site_level_new[df_site_level_new$Clim.PFTs=='Dfc-ENF',],
aes(x=Env_var,y=para,col=PFT),fill=adjustcolor("magenta1"),
method = "lm",formula = y ~ x,lty=2)+
# stat_poly_eq(data=df_site_level_new[df_site_level_new$Clim.PFTs=='Dfc-ENF',],
#                  aes(x=Env_var,y=para,col=PFT,
#                     label = paste(
#                       after_stat(rr.label),
#                       after_stat(p.value.label),
#                       sep = "*\", \"*"),
#                 label.x=0.5,label.y="bottom"))+
# ggforce::geom_mark_ellipse(data=df_site_level_new[df_site_level_new$Clim.PFTs=="Dfc-ENF",],
#                            aes(x=Env_var,y=para,label=Clim.PFTs,group=Clim.PFTs,col=PFT),label.fill = "magenta1",
#                            con.border = "one",con.cap = 0,con.size = 1.1,con.colour = "magenta1",
#                            con.arrow = grid::arrow(angle=30,ends = "last",length = unit(0.1,"inches")))+  ##Dfc-ENF
scale_color_manual(values = c("DBF"="orange","MF"="cyan","ENF"="magenta"))+
xlab(paste0(Env_var," (°C)"))+
ylab(paste0(para," (°C)"))+
theme(
legend.text = element_text(size=22),
legend.position = c(0.15,0.8),
legend.key.size = unit(2, 'lines'),
axis.title = element_text(size=26),
axis.text = element_text(size = 22),
text = element_text(size=24),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.background = element_rect(colour ="grey",fill="white")
)
if(para=="a1"){
pars_final<-pars_final+
annotate(geom = "text",x=-4.1,y=33,label = paste0("italic(R) ^ 2 == ",
stat_DBF_label$r.squared),parse=TRUE,col="orange",size=5)+
annotate(geom = "text",x=1,y=33,label = paste0("italic(p) ==",
round(stat_DBF_label$p.value,2)),parse=TRUE,col="orange",size=5)+
annotate(geom = "text",x=-4.1,y=29,label = paste0("italic(R) ^ 2 == ",
stat_Dfc_ENF_label$r.squared),parse=TRUE,col="magenta",size=5)+
annotate(geom = "text",x=1,y=29,label = paste0("italic(p) == ",
round(stat_Dfc_ENF_label$p.value,2)),parse=TRUE,col="magenta",size=5)
}
##tmin vs a2
if(para=="a2" & Env_var=="tmin"){
pars_final<-pars_final+
annotate(geom = "text",x=-4.1,y=210,label = paste0("italic(R) ^ 2 == ",
stat_DBF_label$r.squared),parse=TRUE,col="orange",size=5)+
annotate(geom = "text",x=1,y=210,label = paste0("italic(p) ==",
round(stat_DBF_label$p.value,2)),parse=TRUE,col="orange",size=5)+
annotate(geom = "text",x=-4.1,y=192,label = paste0("italic(R) ^ 2 == ",
stat_Dfc_ENF_label$r.squared),parse=TRUE,col="magenta",size=5)+
annotate(geom = "text",x=1,y=192,label = paste0("italic(p) == ",
round(stat_Dfc_ENF_label$p.value,2)),parse=TRUE,col="magenta",size=5)
}
if(para=="a2" & Env_var=="tmin_b_GP"){
pars_final<-pars_final+
annotate(geom = "text",x=-25.1,y=210,label = paste0("italic(R) ^ 2 == ",
stat_DBF_label$r.squared),parse=TRUE,col="orange",size=5)+
annotate(geom = "text",x=-20,y=210,label = paste0("italic(p) ==",
round(stat_DBF_label$p.value,2)),parse=TRUE,col="orange",size=5)+
annotate(geom = "text",x=-25.1,y=192,label = paste0("italic(R) ^ 2 == ",
stat_Dfc_ENF_label$r.squared),parse=TRUE,col="magenta",size=5)+
annotate(geom = "text",x=-20,y=192,label = paste0("italic(p) == ",
round(stat_Dfc_ENF_label$p.value,2)),parse=TRUE,col="magenta",size=5)
}
if(para=="a2" & Env_var=="tmin_GP"){
pars_final<-pars_final+
annotate(geom = "text",x=-4.1,y=210,label = paste0("italic(R) ^ 2 == ",
stat_DBF_label$r.squared),parse=TRUE,col="orange",size=5)+
annotate(geom = "text",x=1,y=210,label = paste0("italic(p) ==",
round(stat_DBF_label$p.value,2)),parse=TRUE,col="orange",size=5)+
annotate(geom = "text",x=-4.1,y=192,label = paste0("italic(R) ^ 2 == ",
stat_Dfc_ENF_label$r.squared),parse=TRUE,col="magenta",size=5)+
annotate(geom = "text",x=1,y=192,label = paste0("italic(p) == ",
round(stat_Dfc_ENF_label$p.value,2)),parse=TRUE,col="magenta",size=5)
}
if(para=="a2" & Env_var=="tmin_ES"){
pars_final<-pars_final+
annotate(geom = "text",x=-15.1,y=210,label = paste0("italic(R) ^ 2 == ",
stat_DBF_label$r.squared),parse=TRUE,col="orange",size=5)+
annotate(geom = "text",x=-10,y=210,label = paste0("italic(p) ==",
round(stat_DBF_label$p.value,2)),parse=TRUE,col="orange",size=5)+
annotate(geom = "text",x=-15.1,y=192,label = paste0("italic(R) ^ 2 == ",
stat_Dfc_ENF_label$r.squared),parse=TRUE,col="magenta",size=5)+
annotate(geom = "text",x=-10,y=192,label = paste0("italic(p) == ",
round(stat_Dfc_ENF_label$p.value,2)),parse=TRUE,col="magenta",size=5)
}
################
if(para=="b1"){
pars_final<-pars_final+
annotate(geom = "text",x=-4.1,y=22,label = paste0("italic(R) ^ 2 == ",
stat_DBF_label$r.squared),parse=TRUE,col="orange",size=5)+
annotate(geom = "text",x=1,y=22,label = paste0("italic(p) ==",
round(stat_DBF_label$p.value,2)),parse=TRUE,col="orange",size=5)+
annotate(geom = "text",x=-4.1,y=20,label = paste0("italic(R) ^ 2 == ",
stat_Dfc_ENF_label$r.squared),parse=TRUE,col="magenta1",size=5)+
annotate(geom = "text",x=1,y=20,label = paste0("italic(p) == ",
round(stat_Dfc_ENF_label$p.value,2)),parse=TRUE,col="magenta1",size=5)
}
if(para=="b2"){
pars_final<-pars_final+
annotate(geom = "text",x=-4.1,y=20,label = paste0("italic(R) ^ 2 == ",
stat_DBF_label$r.squared),parse=TRUE,col="orange",size=5)+
annotate(geom = "text",x=1,y=20,label = paste0("italic(p) ==",
round(stat_DBF_label$p.value,2)),parse=TRUE,col="orange",size=5)+
annotate(geom = "text",x=-4.1,y=18,label = paste0("italic(R) ^ 2 == ",
stat_Dfc_ENF_label$r.squared),parse=TRUE,col="magenta1",size=5)+
annotate(geom = "text",x=1,y=18,label = paste0("italic(p) == ",
round(stat_Dfc_ENF_label$p.value,2)),parse=TRUE,col="magenta1",size=5)
}
if(para=="k"){
pars_final<-pars_final+
annotate(geom = "text",x=-10.1,y=15,label = paste0("italic(R) ^ 2 == ",
stat_DBF_label$r.squared),parse=TRUE,col="orange",size=5)+
annotate(geom = "text",x=-5,y=15,label = paste0("italic(p) ==",
round(stat_DBF_label$p.value,2)),parse=TRUE,col="orange",size=5)+
annotate(geom = "text",x=-10.1,y=13,label = paste0("italic(R) ^ 2 == ",
stat_Dfc_ENF_label$r.squared),parse=TRUE,col="magenta1",size=5)+
annotate(geom = "text",x=-5,y=13,label = paste0("italic(p) == ",
round(stat_Dfc_ENF_label$p.value,2)),parse=TRUE,col="magenta1",size=5)
}
if(do_legend==FALSE){
pars_final<-pars_final+
theme(legend.position = "none")
}
#
return(pars_final)
}
p_tmin_a2<-plot_paras(df = plot_data,Env_var = "tmin",
para = "a2",FALSE)
p_tmin_b_GP_a2<-plot_paras(df = plot_data,Env_var = "tmin_b_GP",
para = "a2",FALSE)
p_tmin_GP_a2<-plot_paras(df = plot_data,Env_var = "tmin_GP",
para = "a2",FALSE)
p_tmin_ES_a2<-plot_paras(df = plot_data,Env_var = "tmin_ES",
para = "a2",FALSE)
#merge the plots:
paras_range<-cowplot::plot_grid(p_tmin_a2,p_tmin_b_GP_a2,
p_tmin_GP_a2,p_tmin_ES_a2,
nrow=2, ncol = 2,labels = "auto",label_size = 20,align = "hv")
#save the plot
save.path<-"./manuscript/test_files/check_paras_in_Beni_method/"
ggsave(paste0(save.path,"Check_paras_beni_method_min_Tmin_vs_a2.png"),
paras_range,width = 18,height = 15)
#######################################################
##Aim: improve p-model performance
##both for the early spring and peak season
#######################################################
#At the end, adopt the Mekela et al., 2008 to improve the model representation
#----------
library(tidyverse)
library(dplyr)
library(GenSA)
library(lubridate)
# remotes::install_github("computationales/ingestr") #install the package
library(ingestr)
#-------------------------
#(1)load the data and hardening funciton
#-------------------------
#####
#load the data uploaded by Koen
df_recent <- readRDS(paste0("./data-raw/raw_data/P_model_output/model_data.rds")) %>%
mutate(
year = format(date, "%Y")
) %>%
na.omit()
sites<-unique(df_recent$sitename)
#
library(ggplot2)
for (i in 1:length(sites)) {
df_temp<-df_recent %>%
filter(sitename==sites[i])
text.Date<-min(df_temp$date)+c(max(df_temp$date)-min(df_temp$date))*0.1
#
df_plot<-df_temp %>%
ggplot()+
geom_point(aes(x=date,y=gpp))+
geom_point(aes(x=date,y=gpp_mod),col="red")+
annotate(geom = "text",x=text.Date,y=15,label=sites[i])
#
k=quantile(df_temp$gpp,probs = c(0.01,0.05,seq(0.1,0.9,0.1)),0.95,0.99)
df_plot+
geom_hline(yintercept = k,col="blue")
}
#filter the observational gpp data:
# df_recent_new<-c()
# for (i in 1:length(sites)) {
#   df_temp<-df_recent %>%
#     filter(sitename==sites[i])
#   #filter the gpp observation data(remove the gpp that below 5 percentile and negative):
#   k=quantile(df_temp$gpp,probs = c(0.01,0.05,seq(0.1,0.9,0.1)),0.95,0.99)
#   df_temp$gpp[df_temp$gpp<as.numeric(k[2])& df_temp$gpp<0]<-NA
#   # df_temp %>%
#   #   ggplot()+
#   #   geom_point(aes(x=date,y=gpp))+
#   #   geom_point(aes(x=date,y=gpp_mod),col="red")+
#   #   annotate(geom = "text",x=text.Date,y=15,label=sites[i])
#   df_recent_new<-rbind(df_recent_new,df_temp)
# }
#do not filter the observation gpp in study:
df_recent_new<-df_recent
#load the data Beni sent me before:
df_old<-read.csv(file=paste0("./data-raw/raw_data/Data_sent_by_Beni/","ddf_fluxnet2015_pmodel_with_forcings_stocker19gmd.csv"))
df_old<-df_old %>%
mutate(date=lubridate::mdy(date),
year=lubridate::year(date)) %>%
na.omit(gpp_obs)
##------------------
plot_temp<-df_old %>%
mutate(doy=lubridate::yday(date))%>%
select(sitename,doy,gpp_mod_FULL,gpp_mod_ORG)%>%
group_by(sitename,doy)%>%
summarise(gpp_mod_ORG=mean(gpp_mod_ORG),gpp_mod_FULL=mean(gpp_mod_FULL))%>%
pivot_longer(c(gpp_mod_FULL,gpp_mod_ORG),values_to = "GPP",names_to = "Source")%>%
ggplot(aes(x=doy,y=GPP,col=Source))+
geom_point()+
facet_wrap(.~sitename)
temp.path<-"./manuscript/test_files/"
##------------------
plot_temp<-df_old %>%
mutate(doy=lubridate::yday(date))%>%
select(sitename,doy,gpp_mod_FULL,gpp_mod_ORG)%>%
group_by(sitename,doy)%>%
summarise(gpp_mod_ORG=mean(gpp_mod_ORG),gpp_mod_FULL=mean(gpp_mod_FULL))%>%
pivot_longer(c(gpp_mod_FULL,gpp_mod_ORG),values_to = "GPP",names_to = "Source")%>%
ggplot(aes(x=doy,y=GPP,col=Source))+
geom_point()+
facet_wrap(.~sitename)
temp.path<-"./manuscript/test_files/"
ggsave(plot_temp,filename = paste0(temp.path,"gpp_Pmodel_GPP_Full_vs_GPP_ORG.pdf"))
temp.path<-"./manuscript/test_files/"
ggsave(plot_temp,filename = paste0(temp.path,"gpp_Pmodel_GPP_Full_vs_GPP_ORG.pdf"),width = 15,height = 10)
