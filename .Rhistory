#   values=c("black", "red", "royalblue", "darkgoldenrod", "springgreen", "orchid4"))+
scale_color_manual("GPP sources",values = c("gpp_obs" = "black",
"gpp_pmodel" = "orange", "gpp_lmer" = "brown2"),
labels = c(expression(GPP[obs]),expression(GPP[Pmodel]),expression(GPP[LME])))+
# labels = c("Observations","P-model","LME")) +
theme(
legend.text = element_text(size=20),
legend.key.size = unit(2, 'lines'),
axis.title = element_text(size=24),
axis.text = element_text(size = 20),
text = element_text(size=24),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.background = element_rect(colour ="grey",fill="white"),
# legend.background = element_blank(),
legend.position = c(0.75,0.1)
)+
theme(legend.text.align = 0)
df_meandoy_norm_Clim_PFTs %>%
filter(!is.nan(gpp_lmer) & !is.infinite(gpp_lmer))%>% ##this filter is important
pivot_longer(c(gpp_obs, gpp_pmodel, gpp_lue_const, gpp_temp_vpd,gpp_lmer), names_to = "model", values_to = "gpp") %>%
mutate(model = fct_relevel(model, "gpp_obs", "gpp_pmodel", "gpp_lue_const", "gpp_temp_vpd","gpp_lmer")) %>%
dplyr::filter((model %in% c( "gpp_obs", "gpp_pmodel","gpp_lmer"))) %>% ##select only one lm
ggplot() +
geom_line(aes(x = doy, y = gpp, color = model),size=0.8) +
geom_ribbon(aes(x=doy,ymin=gpp_obs_mean - gpp_obs_sd,ymax=gpp_obs_mean + gpp_obs_sd),fill="black",alpha=0.3)+
#adding the gpp bias-->May,2023:
geom_segment(aes(x=120,y=0,xend=120+gpp_bias_pmodel_greenup*50,yend=0),col="orange",size=1.1)+
geom_segment(aes(x=120,y=-1,xend=120+gpp_bias_lmer_greenup*50,yend=-1),col="brown2",size=1.1)+
geom_segment(aes(x=120,y=-3,xend=120,yend=3),col="grey",size=1.1)+
#adding the bias value:
geom_text(aes(x=140,y=2,label=round(gpp_bias_pmodel_greenup,2)))+
geom_text(aes(x=140,y=-4,label=round(gpp_bias_lmer_greenup,2)))+
labs(y = expression( paste("GPP (g C m"^-2, " d"^-1, ")" ) ),
x = "DoY") +
# facet_wrap( ~Clim_PFTs, ncol = 3, scales = "free_y" ) +
facet_wrap( ~Clim_PFTs) +
# theme_gray() +
# theme(legend.position = "bottom") +
# scale_color_manual(
#   name="Model: ",
#   values=c("black", "red", "royalblue", "darkgoldenrod", "springgreen", "orchid4"))+
scale_color_manual("GPP sources",values = c("gpp_obs" = "black",
"gpp_pmodel" = "orange", "gpp_lmer" = "brown2"),
labels = c(expression(GPP[obs]),expression(GPP[Pmodel]),expression(GPP[LME])))+
# labels = c("Observations","P-model","LME")) +
theme(
legend.text = element_text(size=20),
legend.key.size = unit(2, 'lines'),
axis.title = element_text(size=24),
axis.text = element_text(size = 20),
text = element_text(size=24),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.background = element_rect(colour ="grey",fill="white"),
# legend.background = element_blank(),
legend.position = c(0.75,0.1)
)+
theme(legend.text.align = 0)
df_meandoy_norm_Clim_PFTs %>%
filter(!is.nan(gpp_lmer) & !is.infinite(gpp_lmer))%>% ##this filter is important
pivot_longer(c(gpp_obs, gpp_pmodel, gpp_lue_const, gpp_temp_vpd,gpp_lmer), names_to = "model", values_to = "gpp") %>%
mutate(model = fct_relevel(model, "gpp_obs", "gpp_pmodel", "gpp_lue_const", "gpp_temp_vpd","gpp_lmer")) %>%
dplyr::filter((model %in% c( "gpp_obs", "gpp_pmodel","gpp_lmer"))) %>% ##select only one lm
ggplot() +
geom_line(aes(x = doy, y = gpp, color = model),size=0.8) +
geom_ribbon(aes(x=doy,ymin=gpp_obs_mean - gpp_obs_sd,ymax=gpp_obs_mean + gpp_obs_sd),fill="black",alpha=0.3)+
#adding the gpp bias-->May,2023:
geom_segment(aes(x=120,y=0,xend=120+gpp_bias_pmodel_greenup*50,yend=0),col="orange",size=1.1)+
geom_segment(aes(x=120,y=-1,xend=120+gpp_bias_lmer_greenup*50,yend=-1),col="brown2",size=1.1)+
geom_segment(aes(x=120,y=-3,xend=120,yend=3),col="grey",size=1.1)+
#adding the bias value:
geom_text(aes(x=160,y=2,label=round(gpp_bias_pmodel_greenup,2)))+
geom_text(aes(x=160,y=-2,label=round(gpp_bias_lmer_greenup,2)))+
labs(y = expression( paste("GPP (g C m"^-2, " d"^-1, ")" ) ),
x = "DoY") +
# facet_wrap( ~Clim_PFTs, ncol = 3, scales = "free_y" ) +
facet_wrap( ~Clim_PFTs) +
# theme_gray() +
# theme(legend.position = "bottom") +
# scale_color_manual(
#   name="Model: ",
#   values=c("black", "red", "royalblue", "darkgoldenrod", "springgreen", "orchid4"))+
scale_color_manual("GPP sources",values = c("gpp_obs" = "black",
"gpp_pmodel" = "orange", "gpp_lmer" = "brown2"),
labels = c(expression(GPP[obs]),expression(GPP[Pmodel]),expression(GPP[LME])))+
# labels = c("Observations","P-model","LME")) +
theme(
legend.text = element_text(size=20),
legend.key.size = unit(2, 'lines'),
axis.title = element_text(size=24),
axis.text = element_text(size = 20),
text = element_text(size=24),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.background = element_rect(colour ="grey",fill="white"),
# legend.background = element_blank(),
legend.position = c(0.75,0.1)
)+
theme(legend.text.align = 0)
#Figure for Clim.-PFTs
plot_final<-df_meandoy_norm_Clim_PFTs %>%
filter(!is.nan(gpp_lmer) & !is.infinite(gpp_lmer))%>% ##this filter is important
pivot_longer(c(gpp_obs, gpp_pmodel, gpp_lue_const, gpp_temp_vpd,gpp_lmer), names_to = "model", values_to = "gpp") %>%
mutate(model = fct_relevel(model, "gpp_obs", "gpp_pmodel", "gpp_lue_const", "gpp_temp_vpd","gpp_lmer")) %>%
dplyr::filter((model %in% c( "gpp_obs", "gpp_pmodel","gpp_lmer"))) %>% ##select only one lm
ggplot() +
geom_line(aes(x = doy, y = gpp, color = model),size=0.8) +
geom_ribbon(aes(x=doy,ymin=gpp_obs_mean - gpp_obs_sd,ymax=gpp_obs_mean + gpp_obs_sd),fill="black",alpha=0.3)+
#adding the gpp bias-->May,2023:
geom_segment(aes(x=120,y=0,xend=120+gpp_bias_pmodel_greenup*50,yend=0),col="orange",size=1.1)+
geom_segment(aes(x=120,y=-1,xend=120+gpp_bias_lmer_greenup*50,yend=-1),col="brown2",size=1.1)+
geom_segment(aes(x=120,y=-3,xend=120,yend=3),col=adjustcolor("black",0.8),size=1.1)+
#adding the bias value:
geom_text(aes(x=160,y=2,label=round(gpp_bias_pmodel_greenup,2)))+
geom_text(aes(x=160,y=-2,label=round(gpp_bias_lmer_greenup,2)))+
labs(y = expression( paste("GPP (g C m"^-2, " d"^-1, ")" ) ),
x = "DoY") +
# facet_wrap( ~Clim_PFTs, ncol = 3, scales = "free_y" ) +
facet_wrap( ~Clim_PFTs) +
# theme_gray() +
# theme(legend.position = "bottom") +
# scale_color_manual(
#   name="Model: ",
#   values=c("black", "red", "royalblue", "darkgoldenrod", "springgreen", "orchid4"))+
scale_color_manual("GPP sources",values = c("gpp_obs" = "black",
"gpp_pmodel" = "orange", "gpp_lmer" = "brown2"),
labels = c(expression(GPP[obs]),expression(GPP[Pmodel]),expression(GPP[LME])))+
# labels = c("Observations","P-model","LME")) +
theme(
legend.text = element_text(size=20),
legend.key.size = unit(2, 'lines'),
axis.title = element_text(size=24),
axis.text = element_text(size = 20),
text = element_text(size=24),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.background = element_rect(colour ="grey",fill="white"),
# legend.background = element_blank(),
legend.position = c(0.75,0.1)
)+
theme(legend.text.align = 0)  #align the legend (all the letter start at the same positoin)
##adding the site number in each Clim-PFTs panel:
#update using original p-model
##
nsites<-ddf_norm %>%
group_by(Clim_PFTs)%>%
dplyr::summarise(nsite=length(unique(sitename)))
nsites$label<-paste0("N = ",nsites$nsite)
sites_num.info<-data.frame(
doy=rep(20,nrow(nsites)),
gpp=rep(14,nrow(nsites)),
nsites
)
#function to add the site number info:
#print the plot
tag_facet <- function(p, open = "", close = "", tag_pool = letters, x = -Inf, y = Inf,
hjust = -0.5, vjust = 1.5, fontface = 2, family = "", ...) {
gb <- ggplot_build(p)
lay <- gb$layout$layout
tags <- cbind(lay, label = paste0(open, tag_pool[lay$PANEL], close), x = x, y = y)
p + geom_text(data = tags, aes_string(x = "x", y = "y", label = "label"), ..., hjust = hjust,
vjust = vjust, fontface = fontface, family = family, inherit.aes = FALSE)
}
library(egg)
plot_final_addN<-tag_facet(plot_final,x=sites_num.info$doy,y=sites_num.info$gpp,
tag_pool = sites_num.info$label,size=5)
plot_final_add
plot_final_addN
#Figure for Clim.-PFTs
plot_final<-df_meandoy_norm_Clim_PFTs %>%
filter(!is.nan(gpp_lmer) & !is.infinite(gpp_lmer))%>% ##this filter is important
pivot_longer(c(gpp_obs, gpp_pmodel, gpp_lue_const, gpp_temp_vpd,gpp_lmer), names_to = "model", values_to = "gpp") %>%
mutate(model = fct_relevel(model, "gpp_obs", "gpp_pmodel", "gpp_lue_const", "gpp_temp_vpd","gpp_lmer")) %>%
dplyr::filter((model %in% c( "gpp_obs", "gpp_pmodel","gpp_lmer"))) %>% ##select only one lm
ggplot() +
geom_line(aes(x = doy, y = gpp, color = model),size=0.8) +
geom_ribbon(aes(x=doy,ymin=gpp_obs_mean - gpp_obs_sd,ymax=gpp_obs_mean + gpp_obs_sd),fill="black",alpha=0.3)+
#adding the gpp bias-->May,2023:
geom_segment(aes(x=120,y=0,xend=120+gpp_bias_pmodel_greenup*50,yend=0),col="orange",size=1.1)+
geom_segment(aes(x=120,y=-1,xend=120+gpp_bias_lmer_greenup*50,yend=-1),col="brown2",size=1.1)+
geom_segment(aes(x=120,y=-1.1,xend=120,yend=0.1),col=adjustcolor("black",0.8),size=1.1)+
#adding the bias value:
geom_text(aes(x=160,y=2,label=round(gpp_bias_pmodel_greenup,2)))+
geom_text(aes(x=160,y=-2,label=round(gpp_bias_lmer_greenup,2)))+
labs(y = expression( paste("GPP (g C m"^-2, " d"^-1, ")" ) ),
x = "DoY") +
# facet_wrap( ~Clim_PFTs, ncol = 3, scales = "free_y" ) +
facet_wrap( ~Clim_PFTs) +
# theme_gray() +
# theme(legend.position = "bottom") +
# scale_color_manual(
#   name="Model: ",
#   values=c("black", "red", "royalblue", "darkgoldenrod", "springgreen", "orchid4"))+
scale_color_manual("GPP sources",values = c("gpp_obs" = "black",
"gpp_pmodel" = "orange", "gpp_lmer" = "brown2"),
labels = c(expression(GPP[obs]),expression(GPP[Pmodel]),expression(GPP[LME])))+
# labels = c("Observations","P-model","LME")) +
theme(
legend.text = element_text(size=20),
legend.key.size = unit(2, 'lines'),
axis.title = element_text(size=24),
axis.text = element_text(size = 20),
text = element_text(size=24),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.background = element_rect(colour ="grey",fill="white"),
# legend.background = element_blank(),
legend.position = c(0.75,0.1)
)+
theme(legend.text.align = 0)  #align the legend (all the letter start at the same positoin)
##adding the site number in each Clim-PFTs panel:
#update using original p-model
##
nsites<-ddf_norm %>%
group_by(Clim_PFTs)%>%
dplyr::summarise(nsite=length(unique(sitename)))
nsites$label<-paste0("N = ",nsites$nsite)
sites_num.info<-data.frame(
doy=rep(20,nrow(nsites)),
gpp=rep(14,nrow(nsites)),
nsites
)
#function to add the site number info:
#print the plot
tag_facet <- function(p, open = "", close = "", tag_pool = letters, x = -Inf, y = Inf,
hjust = -0.5, vjust = 1.5, fontface = 2, family = "", ...) {
gb <- ggplot_build(p)
lay <- gb$layout$layout
tags <- cbind(lay, label = paste0(open, tag_pool[lay$PANEL], close), x = x, y = y)
p + geom_text(data = tags, aes_string(x = "x", y = "y", label = "label"), ..., hjust = hjust,
vjust = vjust, fontface = fontface, family = family, inherit.aes = FALSE)
}
library(egg)
plot_final_addN<-tag_facet(plot_final,x=sites_num.info$doy,y=sites_num.info$gpp,
tag_pool = sites_num.info$label,size=5)
plot_final_addN
#Figure for Clim.-PFTs
plot_final<-df_meandoy_norm_Clim_PFTs %>%
filter(!is.nan(gpp_lmer) & !is.infinite(gpp_lmer))%>% ##this filter is important
pivot_longer(c(gpp_obs, gpp_pmodel, gpp_lue_const, gpp_temp_vpd,gpp_lmer), names_to = "model", values_to = "gpp") %>%
mutate(model = fct_relevel(model, "gpp_obs", "gpp_pmodel", "gpp_lue_const", "gpp_temp_vpd","gpp_lmer")) %>%
dplyr::filter((model %in% c( "gpp_obs", "gpp_pmodel","gpp_lmer"))) %>% ##select only one lm
ggplot() +
geom_line(aes(x = doy, y = gpp, color = model),size=0.8) +
geom_ribbon(aes(x=doy,ymin=gpp_obs_mean - gpp_obs_sd,ymax=gpp_obs_mean + gpp_obs_sd),fill="black",alpha=0.3)+
#adding the gpp bias-->May,2023:
geom_segment(aes(x=120,y=0,xend=120+gpp_bias_pmodel_greenup*50,yend=0),col="orange",size=1.1)+
geom_segment(aes(x=120,y=-1,xend=120+gpp_bias_lmer_greenup*50,yend=-1),col="brown2",size=1.1)+
geom_segment(aes(x=120,y=-1.8,xend=120,yend=0.8),col=adjustcolor("black",0.8),size=1.1)+
#adding the bias value:
geom_text(aes(x=160,y=2,label=round(gpp_bias_pmodel_greenup,2)))+
geom_text(aes(x=160,y=-2,label=round(gpp_bias_lmer_greenup,2)))+
labs(y = expression( paste("GPP (g C m"^-2, " d"^-1, ")" ) ),
x = "DoY") +
# facet_wrap( ~Clim_PFTs, ncol = 3, scales = "free_y" ) +
facet_wrap( ~Clim_PFTs) +
# theme_gray() +
# theme(legend.position = "bottom") +
# scale_color_manual(
#   name="Model: ",
#   values=c("black", "red", "royalblue", "darkgoldenrod", "springgreen", "orchid4"))+
scale_color_manual("GPP sources",values = c("gpp_obs" = "black",
"gpp_pmodel" = "orange", "gpp_lmer" = "brown2"),
labels = c(expression(GPP[obs]),expression(GPP[Pmodel]),expression(GPP[LME])))+
# labels = c("Observations","P-model","LME")) +
theme(
legend.text = element_text(size=20),
legend.key.size = unit(2, 'lines'),
axis.title = element_text(size=24),
axis.text = element_text(size = 20),
text = element_text(size=24),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.background = element_rect(colour ="grey",fill="white"),
# legend.background = element_blank(),
legend.position = c(0.75,0.1)
)+
theme(legend.text.align = 0)  #align the legend (all the letter start at the same positoin)
##adding the site number in each Clim-PFTs panel:
#update using original p-model
##
nsites<-ddf_norm %>%
group_by(Clim_PFTs)%>%
dplyr::summarise(nsite=length(unique(sitename)))
nsites$label<-paste0("N = ",nsites$nsite)
sites_num.info<-data.frame(
doy=rep(20,nrow(nsites)),
gpp=rep(14,nrow(nsites)),
nsites
)
#function to add the site number info:
#print the plot
tag_facet <- function(p, open = "", close = "", tag_pool = letters, x = -Inf, y = Inf,
hjust = -0.5, vjust = 1.5, fontface = 2, family = "", ...) {
gb <- ggplot_build(p)
lay <- gb$layout$layout
tags <- cbind(lay, label = paste0(open, tag_pool[lay$PANEL], close), x = x, y = y)
p + geom_text(data = tags, aes_string(x = "x", y = "y", label = "label"), ..., hjust = hjust,
vjust = vjust, fontface = fontface, family = family, inherit.aes = FALSE)
}
library(egg)
plot_final_addN<-tag_facet(plot_final,x=sites_num.info$doy,y=sites_num.info$gpp,
tag_pool = sites_num.info$label,size=5)
#
ggsave("./manuscript/figures/Figure2_gpp_meandoy_norm_forClimPFTs.png",plot_final_addN,width = 15,height = 10)
#Figure for Clim.-PFTs
plot_final<-df_meandoy_norm_Clim_PFTs %>%
filter(!is.nan(gpp_lmer) & !is.infinite(gpp_lmer))%>% ##this filter is important
pivot_longer(c(gpp_obs, gpp_pmodel, gpp_lue_const, gpp_temp_vpd,gpp_lmer), names_to = "model", values_to = "gpp") %>%
mutate(model = fct_relevel(model, "gpp_obs", "gpp_pmodel", "gpp_lue_const", "gpp_temp_vpd","gpp_lmer")) %>%
dplyr::filter((model %in% c( "gpp_obs", "gpp_pmodel","gpp_lmer"))) %>% ##select only one lm
ggplot() +
geom_line(aes(x = doy, y = gpp, color = model),size=0.8) +
geom_ribbon(aes(x=doy,ymin=gpp_obs_mean - gpp_obs_sd,ymax=gpp_obs_mean + gpp_obs_sd),fill="black",alpha=0.3)+
#adding the gpp bias-->May,2023:
geom_segment(aes(x=120,y=0,xend=120+gpp_bias_pmodel_greenup*50,yend=0),col="orange",size=1.1)+
geom_segment(aes(x=120,y=-1,xend=120+gpp_bias_lmer_greenup*50,yend=-1),col="brown2",size=1.1)+
geom_segment(aes(x=120,y=-1.8,xend=120,yend=0.8),col=adjustcolor("black",0.8),size=1.05)+
#adding the bias value:
geom_text(aes(x=160,y=2,label=round(gpp_bias_pmodel_greenup,2)))+
geom_text(aes(x=160,y=-2,label=round(gpp_bias_lmer_greenup,2)))+
labs(y = expression( paste("GPP (g C m"^-2, " d"^-1, ")" ) ),
x = "DoY") +
# facet_wrap( ~Clim_PFTs, ncol = 3, scales = "free_y" ) +
facet_wrap( ~Clim_PFTs) +
# theme_gray() +
# theme(legend.position = "bottom") +
# scale_color_manual(
#   name="Model: ",
#   values=c("black", "red", "royalblue", "darkgoldenrod", "springgreen", "orchid4"))+
scale_color_manual("GPP sources",values = c("gpp_obs" = "black",
"gpp_pmodel" = "orange", "gpp_lmer" = "brown2"),
labels = c(expression(GPP[obs]),expression(GPP[Pmodel]),expression(GPP[LME])))+
# labels = c("Observations","P-model","LME")) +
theme(
legend.text = element_text(size=20),
legend.key.size = unit(2, 'lines'),
axis.title = element_text(size=24),
axis.text = element_text(size = 20),
text = element_text(size=24),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.background = element_rect(colour ="grey",fill="white"),
# legend.background = element_blank(),
legend.position = c(0.75,0.1)
)+
theme(legend.text.align = 0)  #align the legend (all the letter start at the same positoin)
##adding the site number in each Clim-PFTs panel:
#update using original p-model
##
nsites<-ddf_norm %>%
group_by(Clim_PFTs)%>%
dplyr::summarise(nsite=length(unique(sitename)))
nsites$label<-paste0("N = ",nsites$nsite)
sites_num.info<-data.frame(
doy=rep(20,nrow(nsites)),
gpp=rep(14,nrow(nsites)),
nsites
)
#function to add the site number info:
#print the plot
tag_facet <- function(p, open = "", close = "", tag_pool = letters, x = -Inf, y = Inf,
hjust = -0.5, vjust = 1.5, fontface = 2, family = "", ...) {
gb <- ggplot_build(p)
lay <- gb$layout$layout
tags <- cbind(lay, label = paste0(open, tag_pool[lay$PANEL], close), x = x, y = y)
p + geom_text(data = tags, aes_string(x = "x", y = "y", label = "label"), ..., hjust = hjust,
vjust = vjust, fontface = fontface, family = family, inherit.aes = FALSE)
}
library(egg)
plot_final_addN<-tag_facet(plot_final,x=sites_num.info$doy,y=sites_num.info$gpp,
tag_pool = sites_num.info$label,size=5)
plot_final_addN
#Figure for Clim.-PFTs
plot_final<-df_meandoy_norm_Clim_PFTs %>%
filter(!is.nan(gpp_lmer) & !is.infinite(gpp_lmer))%>% ##this filter is important
pivot_longer(c(gpp_obs, gpp_pmodel, gpp_lue_const, gpp_temp_vpd,gpp_lmer), names_to = "model", values_to = "gpp") %>%
mutate(model = fct_relevel(model, "gpp_obs", "gpp_pmodel", "gpp_lue_const", "gpp_temp_vpd","gpp_lmer")) %>%
dplyr::filter((model %in% c( "gpp_obs", "gpp_pmodel","gpp_lmer"))) %>% ##select only one lm
ggplot() +
geom_line(aes(x = doy, y = gpp, color = model),size=0.8) +
geom_ribbon(aes(x=doy,ymin=gpp_obs_mean - gpp_obs_sd,ymax=gpp_obs_mean + gpp_obs_sd),fill="black",alpha=0.3)+
#adding the gpp bias-->May,2023:
geom_segment(aes(x=120,y=0,xend=120+gpp_bias_pmodel_greenup*50,yend=0),col="orange",size=1.1)+
geom_segment(aes(x=120,y=-1,xend=120+gpp_bias_lmer_greenup*50,yend=-1),col="brown2",size=1.1)+
geom_segment(aes(x=120,y=-1.8,xend=120,yend=0.8),col=adjustcolor("black",0.8),size=1.02)+
#adding the bias value:
geom_text(aes(x=160,y=2,label=round(gpp_bias_pmodel_greenup,2)))+
geom_text(aes(x=160,y=-2,label=round(gpp_bias_lmer_greenup,2)))+
labs(y = expression( paste("GPP (g C m"^-2, " d"^-1, ")" ) ),
x = "DoY") +
# facet_wrap( ~Clim_PFTs, ncol = 3, scales = "free_y" ) +
facet_wrap( ~Clim_PFTs) +
# theme_gray() +
# theme(legend.position = "bottom") +
# scale_color_manual(
#   name="Model: ",
#   values=c("black", "red", "royalblue", "darkgoldenrod", "springgreen", "orchid4"))+
scale_color_manual("GPP sources",values = c("gpp_obs" = "black",
"gpp_pmodel" = "orange", "gpp_lmer" = "brown2"),
labels = c(expression(GPP[obs]),expression(GPP[Pmodel]),expression(GPP[LME])))+
# labels = c("Observations","P-model","LME")) +
theme(
legend.text = element_text(size=20),
legend.key.size = unit(2, 'lines'),
axis.title = element_text(size=24),
axis.text = element_text(size = 20),
text = element_text(size=24),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.background = element_rect(colour ="grey",fill="white"),
# legend.background = element_blank(),
legend.position = c(0.75,0.1)
)+
theme(legend.text.align = 0)  #align the legend (all the letter start at the same positoin)
##adding the site number in each Clim-PFTs panel:
#update using original p-model
##
nsites<-ddf_norm %>%
group_by(Clim_PFTs)%>%
dplyr::summarise(nsite=length(unique(sitename)))
nsites$label<-paste0("N = ",nsites$nsite)
sites_num.info<-data.frame(
doy=rep(20,nrow(nsites)),
gpp=rep(14,nrow(nsites)),
nsites
)
#function to add the site number info:
#print the plot
tag_facet <- function(p, open = "", close = "", tag_pool = letters, x = -Inf, y = Inf,
hjust = -0.5, vjust = 1.5, fontface = 2, family = "", ...) {
gb <- ggplot_build(p)
lay <- gb$layout$layout
tags <- cbind(lay, label = paste0(open, tag_pool[lay$PANEL], close), x = x, y = y)
p + geom_text(data = tags, aes_string(x = "x", y = "y", label = "label"), ..., hjust = hjust,
vjust = vjust, fontface = fontface, family = family, inherit.aes = FALSE)
}
library(egg)
plot_final_addN<-tag_facet(plot_final,x=sites_num.info$doy,y=sites_num.info$gpp,
tag_pool = sites_num.info$label,size=5)
#
ggsave("./manuscript/figures/Figure2_gpp_meandoy_norm_forClimPFTs.png",plot_final_addN,width = 15,height = 10)
#Figure for Clim.-PFTs
plot_final<-df_meandoy_norm_Clim_PFTs %>%
filter(!is.nan(gpp_lmer) & !is.infinite(gpp_lmer))%>% ##this filter is important
pivot_longer(c(gpp_obs, gpp_pmodel, gpp_lue_const, gpp_temp_vpd,gpp_lmer), names_to = "model", values_to = "gpp") %>%
mutate(model = fct_relevel(model, "gpp_obs", "gpp_pmodel", "gpp_lue_const", "gpp_temp_vpd","gpp_lmer")) %>%
dplyr::filter((model %in% c( "gpp_obs", "gpp_pmodel","gpp_lmer"))) %>% ##select only one lm
ggplot() +
geom_line(aes(x = doy, y = gpp, color = model),size=0.8) +
geom_ribbon(aes(x=doy,ymin=gpp_obs_mean - gpp_obs_sd,ymax=gpp_obs_mean + gpp_obs_sd),fill="black",alpha=0.3)+
#adding the gpp bias-->May,2023:
geom_segment(aes(x=120,y=0,xend=120+gpp_bias_pmodel_greenup*50,yend=0),col="orange",size=1.1)+
geom_segment(aes(x=120,y=-1,xend=120+gpp_bias_lmer_greenup*50,yend=-1),col="brown2",size=1.1)+
geom_segment(aes(x=120,y=-1.8,xend=120,yend=0.8),col=adjustcolor("black",0.8),size=1.02)+
#adding the bias value:
geom_text(aes(x=160,y=1,label=round(gpp_bias_pmodel_greenup,2)))+
geom_text(aes(x=160,y=-2,label=round(gpp_bias_lmer_greenup,2)))+
labs(y = expression( paste("GPP (g C m"^-2, " d"^-1, ")" ) ),
x = "DoY") +
# facet_wrap( ~Clim_PFTs, ncol = 3, scales = "free_y" ) +
facet_wrap( ~Clim_PFTs) +
# theme_gray() +
# theme(legend.position = "bottom") +
# scale_color_manual(
#   name="Model: ",
#   values=c("black", "red", "royalblue", "darkgoldenrod", "springgreen", "orchid4"))+
scale_color_manual("GPP sources",values = c("gpp_obs" = "black",
"gpp_pmodel" = "orange", "gpp_lmer" = "brown2"),
labels = c(expression(GPP[obs]),expression(GPP[Pmodel]),expression(GPP[LME])))+
# labels = c("Observations","P-model","LME")) +
theme(
legend.text = element_text(size=20),
legend.key.size = unit(2, 'lines'),
axis.title = element_text(size=24),
axis.text = element_text(size = 20),
text = element_text(size=24),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.background = element_rect(colour ="grey",fill="white"),
# legend.background = element_blank(),
legend.position = c(0.75,0.1)
)+
theme(legend.text.align = 0)  #align the legend (all the letter start at the same positoin)
##adding the site number in each Clim-PFTs panel:
#update using original p-model
##
nsites<-ddf_norm %>%
group_by(Clim_PFTs)%>%
dplyr::summarise(nsite=length(unique(sitename)))
nsites$label<-paste0("N = ",nsites$nsite)
sites_num.info<-data.frame(
doy=rep(20,nrow(nsites)),
gpp=rep(14,nrow(nsites)),
nsites
)
#function to add the site number info:
#print the plot
tag_facet <- function(p, open = "", close = "", tag_pool = letters, x = -Inf, y = Inf,
hjust = -0.5, vjust = 1.5, fontface = 2, family = "", ...) {
gb <- ggplot_build(p)
lay <- gb$layout$layout
tags <- cbind(lay, label = paste0(open, tag_pool[lay$PANEL], close), x = x, y = y)
p + geom_text(data = tags, aes_string(x = "x", y = "y", label = "label"), ..., hjust = hjust,
vjust = vjust, fontface = fontface, family = family, inherit.aes = FALSE)
}
library(egg)
plot_final_addN<-tag_facet(plot_final,x=sites_num.info$doy,y=sites_num.info$gpp,
tag_pool = sites_num.info$label,size=5)
#
ggsave("./manuscript/figures/Figure2_gpp_meandoy_norm_forClimPFTs.png",plot_final_addN,width = 15,height = 10)
